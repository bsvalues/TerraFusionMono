{% extends "base.html" %}

{% block title %}MCP Assessor Agent API - Query Builder{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/darcula.min.css">
<style>
    .CodeMirror {
        height: auto;
        min-height: 200px;
        border: 1px solid #666;
        border-radius: 4px;
    }
    .param-field {
        margin-bottom: 10px;
        position: relative;
    }
    .param-field .btn-close {
        position: absolute;
        right: 10px;
        top: 10px;
    }
    .results-container {
        max-height: 400px;
        overflow: auto;
    }
    .results-table {
        font-size: 0.9rem;
    }
    .results-table th {
        position: sticky;
        top: 0;
        background-color: var(--bs-dark);
        z-index: 10;
    }
    .schema-section {
        max-height: 600px;
        overflow-y: auto;
    }
    .schema-table {
        cursor: pointer;
    }
    .schema-table-columns {
        padding-left: 20px;
    }
    .schema-column {
        cursor: pointer;
        padding: 5px 0;
    }
    .badge {
        font-size: 0.7rem;
    }
    .table-name {
        font-weight: bold;
    }
    .parameter-badge {
        cursor: pointer;
    }
    .nav-tabs .nav-link {
        color: var(--bs-light);
    }
    .nav-tabs .nav-link.active {
        color: var(--bs-dark);
    }
    .example-query {
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .example-query:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    .pagination-info {
        font-size: 0.85rem;
    }
    .stats-info {
        font-size: 0.85rem;
    }
    .highlighted {
        background-color: rgba(var(--bs-warning-rgb), 0.3);
    }
    #detection-placeholder {
        font-style: italic;
        color: var(--bs-gray-500);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">Interactive Query Builder</h1>
    
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-dark">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="query-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="sql-tab" data-bs-toggle="tab" data-bs-target="#sql-panel" type="button" role="tab" aria-controls="sql-panel" aria-selected="true">SQL Query Builder</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="natural-tab" data-bs-toggle="tab" data-bs-target="#natural-panel" type="button" role="tab" aria-controls="natural-panel" aria-selected="false">Natural Language</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="schema-tab" data-bs-toggle="tab" data-bs-target="#schema-panel" type="button" role="tab" aria-controls="schema-panel" aria-selected="false">Database Schema</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="examples-tab" data-bs-toggle="tab" data-bs-target="#examples-panel" type="button" role="tab" aria-controls="examples-panel" aria-selected="false">Example Queries</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="query-tab-content">
                        <!-- SQL Query Builder Panel -->
                        <div class="tab-pane fade show active" id="sql-panel" role="tabpanel" aria-labelledby="sql-tab">
                            <form id="sql-query-form">
                                <div class="mb-3">
                                    <label for="sqlQuery" class="form-label">SQL Query:</label>
                                    <textarea id="sqlQuery" class="form-control"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">Query Parameters:</label>
                                        <button type="button" id="add-param-btn" class="btn btn-sm btn-outline-info">
                                            <i class="bi bi-plus"></i> Add Parameter
                                        </button>
                                    </div>
                                    <div id="parameter-detection" class="mb-2">
                                        <span id="detection-placeholder">Parameters will be detected from your query...</span>
                                    </div>
                                    <div id="parameters-container">
                                        <!-- Dynamic parameters will be added here -->
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="dbType" class="form-label">Database Type:</label>
                                        <select id="dbType" class="form-select">
                                            <option value="postgres">PostgreSQL</option>
                                            <option value="mssql" disabled>Microsoft SQL Server (Coming Soon)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="pageNumber" class="form-label">Page Number:</label>
                                        <input type="number" id="pageNumber" class="form-control" value="1" min="1">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="pageSize" class="form-label">Page Size:</label>
                                        <input type="number" id="pageSize" class="form-control" value="25" min="1" max="100">
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="submit" class="btn btn-primary">Run Query</button>
                                    <div>
                                        <button type="button" id="clear-params-btn" class="btn btn-outline-secondary me-2">Clear Parameters</button>
                                        <button type="button" id="clear-query-btn" class="btn btn-outline-secondary">Clear Query</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Natural Language Panel -->
                        <div class="tab-pane fade" id="natural-panel" role="tabpanel" aria-labelledby="natural-tab">
                            <form id="nl-query-form">
                                <div class="mb-3">
                                    <label for="nlPrompt" class="form-label">Enter your query in plain English:</label>
                                    <textarea id="nlPrompt" class="form-control" rows="5" placeholder="Example: Find all properties with a total value greater than $500,000 in Seattle"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="nlDbType" class="form-label">Database Type:</label>
                                    <select id="nlDbType" class="form-select">
                                        <option value="postgres">PostgreSQL</option>
                                        <option value="mssql" disabled>Microsoft SQL Server (Coming Soon)</option>
                                    </select>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="includeSchema" checked>
                                    <label class="form-check-label" for="includeSchema">Include database schema in request</label>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button type="submit" class="btn btn-primary">Translate to SQL</button>
                                    <button type="button" id="clear-nl-btn" class="btn btn-outline-secondary">Clear</button>
                                </div>
                            </form>
                            
                            <div id="nl-result" class="mt-4" style="display: none;">
                                <div class="card bg-dark">
                                    <div class="card-header d-flex justify-content-between">
                                        <span>Generated SQL Query</span>
                                        <div>
                                            <button type="button" id="use-sql-btn" class="btn btn-sm btn-outline-success">Use This SQL</button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <pre id="generated-sql" class="bg-dark text-light p-3 border border-secondary rounded"></pre>
                                        <div id="sql-explanation" class="mt-3 p-3 border border-secondary rounded"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Schema Panel -->
                        <div class="tab-pane fade" id="schema-panel" role="tabpanel" aria-labelledby="schema-tab">
                            <div class="d-flex justify-content-between mb-3">
                                <label class="form-label">Database Schema:</label>
                                <div>
                                    <select id="schemaDbType" class="form-select form-select-sm">
                                        <option value="postgres">PostgreSQL</option>
                                        <option value="mssql" disabled>Microsoft SQL Server (Coming Soon)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="schema-section" id="schema-container">
                                <div class="d-flex justify-content-center">
                                    <div class="spinner-border text-light" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Examples Panel -->
                        <div class="tab-pane fade" id="examples-panel" role="tabpanel" aria-labelledby="examples-tab">
                            <div class="list-group">
                                <div class="list-group-item list-group-item-dark d-flex justify-content-between align-items-center">
                                    <strong>Example Queries</strong>
                                    <span class="badge bg-info rounded-pill">Click to use</span>
                                </div>
                                
                                <a href="#" class="list-group-item list-group-item-action example-query">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">Basic Property Search</h6>
                                        <small>Postgres</small>
                                    </div>
                                    <p class="mb-1"><code>SELECT p.parcel_id, p.address, p.city, p.total_value FROM parcels p WHERE p.city = :city ORDER BY p.total_value DESC LIMIT 10</code></p>
                                    <small>Shows top 10 most valuable properties in a specific city</small>
                                </a>
                                
                                <a href="#" class="list-group-item list-group-item-action example-query">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">Property Value Range</h6>
                                        <small>Postgres</small>
                                    </div>
                                    <p class="mb-1"><code>SELECT p.parcel_id, p.address, p.total_value FROM parcels p WHERE p.total_value BETWEEN :min_value AND :max_value ORDER BY p.total_value</code></p>
                                    <small>Finds properties with values in a specific range</small>
                                </a>
                                
                                <a href="#" class="list-group-item list-group-item-action example-query">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">Recent Sales</h6>
                                        <small>Postgres</small>
                                    </div>
                                    <p class="mb-1"><code>SELECT p.address, p.city, s.sale_date, s.sale_price FROM parcels p JOIN sales s ON p.id = s.parcel_id WHERE s.sale_date >= :since_date ORDER BY s.sale_date DESC</code></p>
                                    <small>Lists recent property sales since a specified date</small>
                                </a>
                                
                                <a href="#" class="list-group-item list-group-item-action example-query">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">Property Characteristics</h6>
                                        <small>Postgres</small>
                                    </div>
                                    <p class="mb-1"><code>SELECT p.address, pr.property_type, pr.year_built, pr.square_footage, pr.bedrooms, pr.bathrooms FROM parcels p JOIN properties pr ON p.id = pr.parcel_id WHERE pr.bedrooms >= :min_bedrooms AND pr.bathrooms >= :min_bathrooms</code></p>
                                    <small>Searches for properties with specific characteristics</small>
                                </a>
                                
                                <a href="#" class="list-group-item list-group-item-action example-query">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">Average Property Values by City</h6>
                                        <small>Postgres</small>
                                    </div>
                                    <p class="mb-1"><code>SELECT city, COUNT(*) as property_count, ROUND(AVG(total_value), 2) as avg_value FROM parcels GROUP BY city ORDER BY avg_value DESC</code></p>
                                    <small>Calculates average property values grouped by city</small>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Panel -->
    <div id="results-panel" class="row mb-4" style="display: none;">
        <div class="col-md-12">
            <div class="card bg-dark">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Query Results</span>
                    <div class="d-flex">
                        <button type="button" id="download-csv-btn" class="btn btn-sm btn-outline-success me-2">
                            <i class="bi bi-download"></i> Download CSV
                        </button>
                        <button type="button" id="download-json-btn" class="btn btn-sm btn-outline-info">
                            <i class="bi bi-download"></i> Download JSON
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <div class="stats-info">
                            <span id="execution-time"></span>
                        </div>
                        <div class="pagination-info">
                            <span id="pagination-summary"></span>
                            <div class="btn-group ms-2" role="group" aria-label="Pagination">
                                <button type="button" id="prev-page-btn" class="btn btn-sm btn-outline-secondary" disabled>Previous</button>
                                <button type="button" id="next-page-btn" class="btn btn-sm btn-outline-secondary" disabled>Next</button>
                            </div>
                        </div>
                    </div>
                    </div>
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
                    
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
                    <div id="query-results-container" class="results-container">
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
                        <table id="results-table" class="table table-dark table-hover results-table mb-0">
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
                            <thead id="results-thead">
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
                                <!-- Headers will be inserted here -->
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
                            </thead>
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
                            <tbody id="results-tbody">
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
                                <!-- Results will be inserted here -->
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
                            </tbody>
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
                        </table>
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
                    </div>
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
                </div>
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
            </div>
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
        </div>
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
    </div>
    
    <!-- Include visualization component -->
    {% include "query_visualization.html" %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="/static/js/query_visualization.js"></script>
<script src="/static/js/enhanced_visualizations.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize CodeMirror for SQL editor
        const sqlEditor = CodeMirror.fromTextArea(document.getElementById('sqlQuery'), {
            mode: 'text/x-sql',
            theme: 'darcula',
            lineNumbers: true,
            lineWrapping: true,
            indentWithTabs: true,
            indentUnit: 4,
            matchBrackets: true,
            autoCloseBrackets: true,
            extraKeys: {"Ctrl-Space": "autocomplete"}
        });
        
        // Initialize state
        let currentPage = 1;
        let currentPageSize = 25;
        let totalPages = 0;
        let totalRecords = 0;
        let currentQuery = '';
        let queryParams = {};
        let paramIdCounter = 0;
        let schemaData = null;
        
        // Event handler for SQL Query form submission
        document.getElementById('sql-query-form').addEventListener('submit', function(e) {
            e.preventDefault();
            runSqlQuery();
        });
        
        // Event handler for Natural Language form submission
        document.getElementById('nl-query-form').addEventListener('submit', function(e) {
            e.preventDefault();
            translateNaturalLanguage();
        });
        
        // Clear buttons event handlers
        document.getElementById('clear-query-btn').addEventListener('click', function() {
            sqlEditor.setValue('');
            clearParameters();
        });
        
        document.getElementById('clear-params-btn').addEventListener('click', function() {
            clearParameters();
        });
        
        document.getElementById('clear-nl-btn').addEventListener('click', function() {
            document.getElementById('nlPrompt').value = '';
            document.getElementById('nl-result').style.display = 'none';
        });
        
        // Add parameter button event handler
        document.getElementById('add-param-btn').addEventListener('click', function() {
            addParameter();
        });
        
        // Use SQL button event handler
        document.getElementById('use-sql-btn').addEventListener('click', function() {
            const generatedSql = document.getElementById('generated-sql').textContent;
            sqlEditor.setValue(generatedSql);
            
            // Switch to SQL tab
            document.getElementById('sql-tab').click();
            
            // Detect parameters
            detectParameters(generatedSql);
        });
        
        // Example query click handler
        document.querySelectorAll('.example-query').forEach(example => {
            example.addEventListener('click', function(e) {
                e.preventDefault();
                const query = this.querySelector('code').textContent;
                sqlEditor.setValue(query);
                
                // Switch to SQL tab
                document.getElementById('sql-tab').click();
                
                // Detect parameters
                detectParameters(query);
            });
        });
        
        // Pagination button event handlers
        document.getElementById('prev-page-btn').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                runSqlQuery();
            }
        });
        
        document.getElementById('next-page-btn').addEventListener('click', function() {
            if (currentPage < totalPages) {
                currentPage++;
                runSqlQuery();
            }
        });
        
        // Download buttons event handlers
        document.getElementById('download-csv-btn').addEventListener('click', function() {
            downloadResultsAs('csv');
        });
        
        document.getElementById('download-json-btn').addEventListener('click', function() {
            downloadResultsAs('json');
        });
        
        // Schema database type change handler
        document.getElementById('schemaDbType').addEventListener('change', function() {
            loadDatabaseSchema();
        });
        
        // SQL editor change handler for parameter detection
        sqlEditor.on('change', function() {
            const query = sqlEditor.getValue();
            detectParameters(query);
        });
        
        // Load schema when tab is shown
        document.getElementById('schema-tab').addEventListener('shown.bs.tab', function() {
            if (!schemaData) {
                loadDatabaseSchema();
            }
        });
        
        // Function to run SQL query
        function runSqlQuery() {
            const query = sqlEditor.getValue().trim();
            if (!query) {
                showAlert('Please enter a SQL query', 'danger');
                return;
            }
            
            // Update state
            currentQuery = query;
            currentPage = parseInt(document.getElementById('pageNumber').value) || 1;
            currentPageSize = parseInt(document.getElementById('pageSize').value) || 25;
            
            // Collect parameters
            const paramInputs = document.querySelectorAll('.param-input');
            const paramNameInputs = document.querySelectorAll('.param-name-input');
            
            queryParams = {};
            
            for (let i = 0; i < paramInputs.length; i++) {
                const name = paramNameInputs[i].value;
                const value = paramInputs[i].value;
                
                if (name && value) {
                    queryParams[name] = value;
                }
            }
            
            // Show loading indicator
            showLoading(true);
            
            // Prepare request payload
            const payload = {
                db: document.getElementById('dbType').value,
                query: query,
                params: queryParams,
                param_style: 'named', // Using named parameters style
                page: currentPage,
                page_size: currentPageSize
            };
            
            // Send request
            fetch('/api/parameterized-query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': 'demo-key' // Normally would be a secure API key
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => {
                        throw new Error(error.detail || 'Query execution failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                showLoading(false);
                displayResults(data);
                // Save results for download
                window.lastResults = data;
            })
            .catch(error => {
                showLoading(false);
                showAlert(error.message, 'danger');
                console.error(error);
            });
        }
        
        // Function to translate natural language to SQL
        function translateNaturalLanguage() {
            const prompt = document.getElementById('nlPrompt').value.trim();
            if (!prompt) {
                showAlert('Please enter a natural language query', 'danger');
                return;
            }
            
            // Show loading indicator
            showAlert('Translating your query...', 'info');
            
            // Prepare request payload
            const payload = {
                db: document.getElementById('nlDbType').value,
                prompt: prompt,
                include_schema: document.getElementById('includeSchema').checked
            };
            
            // Send request
            fetch('/api/nl-to-sql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': 'demo-key' // Normally would be a secure API key
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => {
                        throw new Error(error.detail || 'Translation failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                displayTranslation(data);
            })
            .catch(error => {
                showAlert(error.message, 'danger');
                console.error(error);
            });
        }
        
        // Function to load database schema
        function loadDatabaseSchema() {
            const dbType = document.getElementById('schemaDbType').value;
            
            // Show loading indicator
            document.getElementById('schema-container').innerHTML = `
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            // Send request
            fetch(`/api/discover-schema?db=${dbType}`, {
                method: 'GET',
                headers: {
                    'X-API-Key': 'demo-key' // Normally would be a secure API key
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => {
                        throw new Error(error.detail || 'Schema discovery failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                schemaData = data;
                displaySchema(data);
            })
            .catch(error => {
                document.getElementById('schema-container').innerHTML = `
                    <div class="alert alert-danger">
                        Failed to load schema: ${error.message}
                    </div>
                `;
                console.error(error);
            });
        }
        
        // Function to display query results
        function displayResults(data) {
            // Store results globally for visualization and export
            window.lastResults = data;
            
            // Update pagination state
            currentPage = data.pagination.page;
            totalPages = data.pagination.total_pages || data.pagination.pages;
            totalRecords = data.pagination.total_records || data.pagination.total;
            
            // Show results panel
            document.getElementById('results-panel').style.display = 'block';
            
            // Update execution time
            document.getElementById('execution-time').textContent = `Execution time: ${data.execution_time.toFixed(3)}s`;
            
            // Update pagination summary
            const paginationSummary = `
                Showing ${data.data.length} of ${totalRecords} records 
                (Page ${currentPage} of ${totalPages})
            `;
            document.getElementById('pagination-summary').textContent = paginationSummary;
            
            // Update pagination buttons
            document.getElementById('prev-page-btn').disabled = currentPage <= 1;
            document.getElementById('next-page-btn').disabled = currentPage >= totalPages;
            
            // Get table elements
            const thead = document.getElementById('results-thead');
            const tbody = document.getElementById('results-tbody');
            
            // Clear existing content
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // If no results
            if (!data.data || data.data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="100%" class="text-center">No results found</td>
                    </tr>
                `;
                return;
            }
            
            // Create header row
            const headerRow = document.createElement('tr');
            const columns = Object.keys(data.data[0]);
            
            columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            
            // Create data rows
            data.data.forEach(row => {
                const tr = document.createElement('tr');
                
                columns.forEach(column => {
                    const td = document.createElement('td');
                    // Format value based on data type
                    let value = row[column];
                    
                    if (value === null) {
                        td.innerHTML = '<em class="text-muted">NULL</em>';
                    } else if (typeof value === 'object' && value instanceof Date) {
                        td.textContent = value.toLocaleString();
                    } else {
                        td.textContent = value;
                    }
                    
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
            
            // Scroll to results
            document.getElementById('results-panel').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Function to display natural language translation
        function displayTranslation(data) {
            document.getElementById('nl-result').style.display = 'block';
            document.getElementById('generated-sql').textContent = data.sql;
            document.getElementById('sql-explanation').innerHTML = data.explanation;
            
            // Clear any previous alerts
            clearAlerts();
        }
        
        // Function to display database schema
        function displaySchema(data) {
            const schemaContainer = document.getElementById('schema-container');
            
            // Organize schema by tables
            const tables = {
            // Show visualization options if there's data
            if (data.data && data.data.length > 0) {
                document.getElementById('visualization-container').style.display = 'flex';
            }
};
            
            data.db_schema.forEach(item => {
                if (!tables[item.table_name]) {
                    tables[item.table_name] = {
                        name: item.table_name,
                        columns: []
                    };
                }
                
                tables[item.table_name].columns.push(item);
            });
            
            // Build HTML for schema
            let html = '<div class="list-group">';
            
            Object.values(tables).forEach(table => {
                html += `
                    <div class="list-group-item list-group-item-dark schema-table" data-table="${table.name}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="table-name">${table.name}</div>
                            <div>
                                <span class="badge bg-secondary">${table.columns.length} columns</span>
                                <button class="btn btn-sm btn-outline-light ms-2 select-table-btn">
                                    SELECT
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item schema-table-columns" data-table="${table.name}" style="display:none;">
                `;
                
                table.columns.forEach(column => {
                    const badges = [];
                    
                    if (column.is_primary_key) {
                        badges.push('<span class="badge bg-warning ms-1">PK</span>');
                    }
                    
                    if (column.is_foreign_key) {
                        badges.push(`<span class="badge bg-info ms-1">FK → ${column.references_table}.${column.references_column}</span>`);
                    }
                    
                    if (!column.is_nullable) {
                        badges.push('<span class="badge bg-danger ms-1">NOT NULL</span>');
                    }
                    
                    html += `
                        <div class="schema-column" data-column="${column.column_name}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${column.column_name}</strong> 
                                    <span class="text-muted">${column.data_type}</span>
                                    ${badges.join('')}
                                </div>
                                <button class="btn btn-sm btn-outline-light select-column-btn">
                                    SELECT
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            
            schemaContainer.innerHTML = html;
            
            // Add event listeners for schema tables
            document.querySelectorAll('.schema-table').forEach(tableElem => {
                tableElem.addEventListener('click', function(e) {
                    if (e.target.classList.contains('select-table-btn')) {
                        // Handle SELECT button click
                        const tableName = this.dataset.table;
                        const currentQuery = sqlEditor.getValue();
                        
                        if (currentQuery.trim() === '') {
                            sqlEditor.setValue(`SELECT * FROM ${tableName} LIMIT 25`);
                        } else {
                            // Try to intelligently add to existing query
                            const cursorPos = sqlEditor.getCursor();
                            sqlEditor.replaceRange(` ${tableName}`, cursorPos);
                        }
                        
                        // Switch to SQL tab
                        document.getElementById('sql-tab').click();
                        return;
                    }
                    
                    // Toggle columns visibility
                    const tableName = this.dataset.table;
                    const columnsElem = document.querySelector(`.schema-table-columns[data-table="${tableName}"]`);
                    
                    if (columnsElem.style.display === 'none') {
                        columnsElem.style.display = 'block';
                    } else {
                        columnsElem.style.display = 'none';
                    }
                });
            });
            
            // Add event listeners for schema columns
            document.querySelectorAll('.select-column-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    const columnElem = this.closest('.schema-column');
                    const columnName = columnElem.dataset.column;
                    const tableElem = this.closest('.schema-table-columns');
                    const tableName = tableElem.dataset.table;
                    
                    const currentQuery = sqlEditor.getValue();
                    const cursorPos = sqlEditor.getCursor();
                    
                    if (currentQuery.trim() === '') {
                        sqlEditor.setValue(`SELECT ${columnName} FROM ${tableName} LIMIT 25`);
                    } else {
                        // Try to intelligently add to existing query
                        sqlEditor.replaceRange(`${columnName}`, cursorPos);
                    }
                    
                    // Switch to SQL tab
                    document.getElementById('sql-tab').click();
                });
            });
        }
        
        // Function to detect parameters in the query
        function detectParameters(query) {
            if (!query) {
                document.getElementById('detection-placeholder').style.display = 'block';
                document.getElementById('parameter-detection').innerHTML = '<span id="detection-placeholder">Parameters will be detected from your query...</span>';
                return;
            }
            
            // Look for named parameters (e.g. :param_name)
            const namedParamRegex = /:([a-zA-Z_][a-zA-Z0-9_]*)/g;
            const matches = [...query.matchAll(namedParamRegex)];
            
            if (matches.length === 0) {
                document.getElementById('detection-placeholder').style.display = 'block';
                return;
            }
            
            // Hide placeholder
            document.getElementById('detection-placeholder').style.display = 'none';
            
            // Get unique parameter names
            const paramNames = [...new Set(matches.map(match => match[1]))];
            
            // Build HTML for detected parameters
            let html = '<div>Detected parameters: ';
            
            paramNames.forEach((paramName, index) => {
                html += `
                    <span class="badge bg-info parameter-badge" data-param="${paramName}">
                        :${paramName}
                    </span>
                `;
                
                if (index < paramNames.length - 1) {
                    html += ' ';
                }
            });
            
            html += '</div>';
            
            // Update detection UI
            document.getElementById('parameter-detection').innerHTML = html;
            
            // Add event listeners for parameter badges
            document.querySelectorAll('.parameter-badge').forEach(badge => {
                badge.addEventListener('click', function() {
                    const paramName = this.dataset.param;
                    
                    // Check if parameter already exists
                    const existingParam = document.querySelector(`.param-name-input[value="${paramName}"]`);
                    
                    if (!existingParam) {
                        addParameter(paramName);
                    } else {
                        // Highlight existing parameter
                        const paramField = existingParam.closest('.param-field');
                        paramField.classList.add('highlighted');
                        
                        // Remove highlight after a delay
                        setTimeout(() => {
                            paramField.classList.remove('highlighted');
                        }, 2000);
                    }
                });
            });
            
            // Check for existing parameters and add missing ones
            const existingParams = [...document.querySelectorAll('.param-name-input')].map(input => input.value);
            const missingParams = paramNames.filter(param => !existingParams.includes(param));
            
            if (missingParams.length > 0) {
                missingParams.forEach(param => {
                    addParameter(param);
                });
            }
        }
        
        // Function to add a parameter input
        function addParameter(paramName = '') {
            const paramId = `param-${++paramIdCounter}`;
            const parametersContainer = document.getElementById('parameters-container');
            
            const paramFieldHtml = `
                <div class="param-field card bg-dark mb-2">
                    <div class="card-body">
                        <button type="button" class="btn-close btn-close-white" aria-label="Close"></button>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-2">
                                    <label for="${paramId}-name" class="form-label">Parameter Name:</label>
                                    <div class="input-group">
                                        <span class="input-group-text">:</span>
                                        <input type="text" id="${paramId}-name" class="form-control param-name-input" value="${paramName}" placeholder="param_name">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-2">
                                    <label for="${paramId}-type" class="form-label">Type:</label>
                                    <select id="${paramId}-type" class="form-select param-type-select">
                                        <option value="string">String</option>
                                        <option value="number">Number</option>
                                        <option value="boolean">Boolean</option>
                                        <option value="date">Date</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-2">
                                    <label for="${paramId}-value" class="form-label">Value:</label>
                                    <input type="text" id="${paramId}-value" class="form-control param-input" placeholder="Parameter value">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Create parameter field element
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = paramFieldHtml;
            const paramField = tempDiv.firstElementChild;
            
            // Add remove button event listener
            paramField.querySelector('.btn-close').addEventListener('click', function() {
                paramField.remove();
            });
            
            // Add type select event listener
            paramField.querySelector('.param-type-select').addEventListener('change', function() {
                const type = this.value;
                const valueInput = paramField.querySelector('.param-input');
                
                switch (type) {
                    case 'number':
                        valueInput.type = 'number';
                        valueInput.step = 'any';
                        break;
                    case 'boolean':
                        valueInput.type = 'checkbox';
                        break;
                    case 'date':
                        valueInput.type = 'date';
                        break;
                    default:
                        valueInput.type = 'text';
                        break;
                }
            });
            
            // Add parameter field to container
            parametersContainer.appendChild(paramField);
            
            return paramField;
        }
        
        // Function to clear parameters
        function clearParameters() {
            document.getElementById('parameters-container').innerHTML = '';
        }
        
        // Function to download results
        function downloadResultsAs(format) {
            if (!currentQuery || !window.lastResults || !window.lastResults.data || window.lastResults.data.length === 0) {
                showAlert('No results to download', 'warning');
                return;
            }
            
            const data = window.lastResults.data;
            let content, filename, mimeType;
            
            if (format === 'csv') {
                // Get column headers
                const headers = Object.keys(data[0]);
                
                // Create CSV content
                let csvContent = headers.join(',') + '\n';
                
                data.forEach(row => {
                    const values = headers.map(header => {
                        const value = row[header];
                        if (value === null) return '';
                        if (typeof value === 'string') return `"${value.replace(/"/g, '""')}"`;
                        return value;
                    });
                    csvContent += values.join(',') + '\n';
                });
                
                content = csvContent;
                filename = 'query_results.csv';
                mimeType = 'text/csv';
            } else {
                // JSON format
                content = JSON.stringify(data, null, 2);
                filename = 'query_results.json';
                mimeType = 'application/json';
            }
            
            // Create download link
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Function to show loading state
        function showLoading(isLoading) {
            if (isLoading) {
                showAlert('Executing query...', 'info');
            } else {
                clearAlerts();
            }
        }
        
        // Function to show alert
        function showAlert(message, type) {
            clearAlerts();
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
            alertDiv.role = 'alert';
            alertDiv.id = 'query-alert';
            
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            document.getElementById('sql-panel').insertBefore(alertDiv, document.getElementById('sql-query-form').nextSibling);
        }
        
        // Function to clea
        // Visualization code
        const toggleVizBtn = document.getElementById('toggle-viz-btn');
        const chartContainer = document.getElementById('chart-container');
        const visualizationContainer = document.getElementById('visualization-container');
        
        if (toggleVizBtn) {
            toggleVizBtn.addEventListener('click', function() {
                const isHidden = chartContainer.style.display === 'none';
                chartContainer.style.display = isHidden ? 'block' : 'none';
                
                if (isHidden && window.lastResults && window.lastResults.data) {
                    updateChartSelectors();
                    updateChart();
                }
            });
        }
        
        // Chart selectors
        const chartTypeSelect = document.getElementById('chartType');
        const xAxisSelect = document.getElementById('xAxis');
        const yAxisSelect = document.getElementById('yAxis');
        
        if (chartTypeSelect && xAxisSelect && yAxisSelect) {
            chartTypeSelect.addEventListener('change', updateChart);
            xAxisSelect.addEventListener('change', updateChart);
            yAxisSelect.addEventListener('change', updateChart);
        }
        
        // Update chart selectors
        function updateChartSelectors() {
            if (!window.lastResults || !window.lastResults.data || window.lastResults.data.length === 0) {
                return;
            }
            
            // Clear existing options
            xAxisSelect.innerHTML = '';
            yAxisSelect.innerHTML = '';
            
            // Get data columns
            const data = window.lastResults.data;
            const columns = Object.keys(data[0]);
            
            // Get column types
            const numericColumns = getNumericColumns(data);
            const dateColumns = getDateColumns(data);
            const textColumns = getTextColumns(data);
            
            // Add options for X-axis (prefer text/date columns first)
            [...textColumns, ...dateColumns, ...numericColumns, ...columns.filter(c => 
                !textColumns.includes(c) && !dateColumns.includes(c) && !numericColumns.includes(c)
            )].forEach(column => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                xAxisSelect.appendChild(option);
            });
            
            // Add options for Y-axis (prefer numeric columns first)
            [...numericColumns, ...columns.filter(c => !numericColumns.includes(c))].forEach(column => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                yAxisSelect.appendChild(option);
            });
            
            // Set default selections if possible
            if (textColumns.length > 0 && numericColumns.length > 0) {
                xAxisSelect.value = textColumns[0];
                yAxisSelect.value = numericColumns[0];
            } else if (dateColumns.length > 0 && numericColumns.length > 0) {
                xAxisSelect.value = dateColumns[0];
                yAxisSelect.value = numericColumns[0];
            } else if (columns.length >= 2) {
                xAxisSelect.value = columns[0];
                yAxisSelect.value = columns[1];
            }
        }
        
        // Get numeric columns from data
        function getNumericColumns(data) {
            const numericColumns = [];
            if (!data || data.length === 0) return numericColumns;
            
            const firstRow = data[0];
            for (const column in firstRow) {
                // Check if all values in this column are numeric
                const isNumeric = data.every(row => {
                    const val = row[column];
                    return val === null || val === undefined || !isNaN(Number(val));
                });
                
                if (isNumeric) numericColumns.push(column);
            }
            
            return numericColumns;
        }
        
        // Get date columns from data
        function getDateColumns(data) {
            const dateColumns = [];
            if (!data || data.length === 0) return dateColumns;
            
            const firstRow = data[0];
            for (const column in firstRow) {
                // Check if column name suggests a date
                if (column.toLowerCase().includes('date') || 
                    column.toLowerCase().includes('time') ||
                    column.toLowerCase().includes('created') ||
                    column.toLowerCase().includes('updated')) {
                    dateColumns.push(column);
                }
            }
            
            return dateColumns;
        }
        
        // Get text columns from data
        function getTextColumns(data) {
            const textColumns = [];
            if (!data || data.length === 0) return textColumns;
            
            const firstRow = data[0];
            for (const column in firstRow) {
                // Check if column contains text values
                const isText = data.some(row => {
                    const val = row[column];
                    return val !== null && typeof val === 'string' && isNaN(Number(val));
                });
                
                if (isText) textColumns.push(column);
            }
            
            return textColumns;
        }
        
        // Chart instance
        let chartInstance = null;
        
        // Update chart based on selections
        function updateChart() {
            if (!window.lastResults || !window.lastResults.data || window.lastResults.data.length === 0) {
                return;
            }
            
            // Get chart parameters
            const chartType = chartTypeSelect.value;
            const xColumn = xAxisSelect.value;
            const yColumn = yAxisSelect.value;
            
            // Get canvas context
            const ctx = document.getElementById('resultChart').getContext('2d');
            
            // Extract data for chart
            const data = window.lastResults.data;
            const labels = data.map(row => row[xColumn]);
            const values = data.map(row => row[yColumn]);
            
            // Check if values are numeric
            const areValuesNumeric = values.every(val => !isNaN(Number(val)));
            
            // Process data based on type
            let processedLabels, processedData;
            
            if (!areValuesNumeric && (chartType === 'bar' || chartType === 'pie')) {
                // Count occurrences for non-numeric values
                const countMap = {};
                values.forEach(val => {
                    countMap[val] = (countMap[val] || 0) + 1;
                });
                
                processedLabels = Object.keys(countMap);
                processedData = Object.values(countMap);
            } else {
                processedLabels = labels;
                processedData = values.map(val => isNaN(Number(val)) ? 0 : Number(val));
            }
            
            // Choose colors
            const backgroundColors = [
                'rgba(54, 162, 235, 0.5)',
                'rgba(255, 99, 132, 0.5)',
                'rgba(255, 206, 86, 0.5)',
                'rgba(75, 192, 192, 0.5)',
                'rgba(153, 102, 255, 0.5)',
                'rgba(255, 159, 64, 0.5)',
                'rgba(199, 199, 199, 0.5)',
                'rgba(83, 102, 255, 0.5)',
                'rgba(40, 159, 64, 0.5)',
                'rgba(210, 199, 199, 0.5)',
            ];
            
            // Create chart config
            const chartConfig = {
                type: chartType,
                data: {
                    labels: processedLabels,
                    datasets: [{
                        label: yColumn,
                        data: processedData,
                        backgroundColor: chartType === 'pie' ? 
                            backgroundColors.slice(0, processedData.length) : 
                            backgroundColors[0],
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            };
            
            // Remove scales for pie chart
            if (chartType === 'pie') {
                delete chartConfig.options.scales;
            }
            
            // Destroy previous chart if exists
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Create new chart
            chartInstance = new Chart(ctx, chartConfig);
        }
        
        // Show visualization container when results are displayed
        function showVisualization() {
            if (window.lastResults && window.lastResults.data && window.lastResults.data.length > 0) {
                visualizationContainer.style.display = 'flex';
            }
        }
        
        // Clear alert messages
        function clearAlerts() {
            const existingAlert = document.getElementById('query-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
        }
    });
</script>
{% endblock %}


<!-- Visualization Component -->
<div id="visualization-container" class="row mb-4" style="display: none;">
    <div class="col-md-12">
        <div class="card bg-dark">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Data Visualization</span>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-info" id="toggle-viz-btn">
                        <i class="bi bi-bar-chart"></i> Toggle Visualization
                    </button>
                </div>
            </div>
            <div class="card-body" id="chart-container" style="display: none;">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="chartType" class="form-label">Chart Type:</label>
                        <select id="chartType" class="form-select">
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                            <option value="pie">Pie Chart</option>
                            <option value="scatter">Scatter Plot</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="xAxis" class="form-label">X Axis:</label>
                        <select id="xAxis" class="form-select"></select>
                    </div>
                    <div class="col-md-4">
                        <label for="yAxis" class="form-label">Y Axis:</label>
                        <select id="yAxis" class="form-select"></select>
                    </div>
                </div>
                <div style="height: 400px;">
                    <canvas id="resultChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
